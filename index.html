<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Slide Guys Booking</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <style>
    body { background-color: #f8f9fa; font-family: Arial, sans-serif; }

    .booking-form{
      max-width:500px;margin:50px auto;background:white;padding:30px;border-radius:10px;
      box-shadow:0 4px 20px rgba(0,0,0,0.1);
    }
    .form-control{ background-color:#e9f0ff; }
    .btn-primary{ background-color:#006aff;border:none; }
    .btn-primary:hover{ background-color:#0051c9; }
    .logo{ max-height:80px;margin-bottom:20px;border-radius:12px; }

    .unit-grid{
      display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:1rem;text-align:left;
    }
    .unit-card-btn{
      width:100%;border:2px solid #d9e3ff;background:#fff;border-radius:14px;padding:10px;cursor:pointer;
      transition:transform .06s ease, box-shadow .12s ease, border-color .12s ease, opacity .12s ease;
      display:flex;flex-direction:column;align-items:center;justify-content:flex-start;min-height:170px;position:relative;
    }
    .unit-card-btn:hover{ transform:translateY(-1px); box-shadow:0 6px 18px rgba(0,0,0,0.08); border-color:#b8ccff; }
    .unit-card-btn.selected{ border-color:#006aff; box-shadow:0 0 0 3px rgba(0,106,255,0.18); }

    .unit-card-btn img{
      width:100%;height:120px;object-fit:cover;border-radius:12px;background:#eef3ff;
    }
    .unit-card-btn .unit-name{
      margin-top:8px;font-weight:700;font-size:.95rem;text-align:center;line-height:1.15;color:#1b1b1b;
    }

    .unit-badge{
      position:absolute;top:10px;left:10px;font-size:.8rem;font-weight:700;padding:6px 10px;border-radius:999px;
      background:#e9f0ff;color:#1b1b1b;box-shadow:0 4px 10px rgba(0,0,0,0.08);
      border:1px solid rgba(0,0,0,0.06);
    }
    .unit-card-btn.booked{ opacity:.55; border-color:#e1e1e1; }
    .unit-card-btn.booked:hover{ transform:none; box-shadow:none; border-color:#e1e1e1; cursor:not-allowed; }
    .unit-card-btn.booked img{ filter:grayscale(35%); }
    .unit-card-btn.booked .unit-badge{ background:#ffe9ea; }

    .selected-unit-pill{
      background-color:#e9f0ff;padding:10px;border-radius:8px;text-align:left;margin-bottom:10px;font-size:.95rem;
    }

    @media (max-width:420px){
      .unit-grid{ grid-template-columns:1fr; }
      .unit-card-btn{ min-height:210px; }
      .unit-card-btn img{ height:150px; }
    }
  </style>
</head>
<body>
  <div class="booking-form text-center">
    <img src="https://lh3.googleusercontent.com/a-/ALV-UjUTAoSFAR5OUMj0ZCkgLF1RMYoE-Q85G0HPftaFEBBIjjzw9cQ=s265-w265-h265" alt="Slide Guys Logo" class="logo">
    <h2 class="mb-3">Slide Guys Booking</h2>
    <p>Select a unit and the date you would like to reserve. Deliveries within 10 miles of Richfield are free. All other outlying areas are available with a Travel Fee.(To be discussed at time of Booking). No cancellations. Rescheduling is subject to availability. A $50 deposit per unit is due at time of reservation. A team member will contact you shortly after confirmation. We accept cash, check, venmo, cash app, and pay-pal.</p>

    <form id="bookingForm">
      <input type="text" id="name" class="form-control mb-2" placeholder="Full Name" required />
      <input type="tel" id="phone" class="form-control mb-2" placeholder="Phone Number" required />
      <input type="email" id="email" class="form-control mb-2" placeholder="Email Address" required />
      <input type="text" id="address" class="form-control mb-2" placeholder="Address" required />
      <input type="text" id="city" class="form-control mb-2" placeholder="City" required />

      <div class="selected-unit-pill">
        <strong>Selected unit:</strong> <span id="unitDisplayText">None</span>
      </div>

      <div class="unit-grid" id="unitGrid"></div>
      <input type="hidden" id="unit" required />

      <input type="date" id="date" class="form-control mb-3" required />

      <button type="button" id="addToCartBtn" class="btn btn-secondary w-100 mb-2">Add to Cart</button>
      <button type="submit" class="btn btn-primary w-100">Reserve</button>
    </form>

    <div id="successMessage" class="mt-3 text-success" style="display:none;">
      Booking successful!<br>Email Sent!
    </div>
    <div id="errorMessage" class="mt-3 text-danger" style="display:none;">
      That unit is already booked on this date.
    </div>

    <div class="mt-4 text-start" id="cartSection" style="display: none;">
      <h5>Cart</h5>
      <ul class="list-group" id="cartList"></ul>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script>
    (function () { emailjs.init("PXm_wNk9aIao8Hlpp"); })();
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const today = new Date();
      const currentYear = today.getFullYear();
      const allowedStart = new Date(`${currentYear}-01-01`);
      const allowedEnd = new Date(`${currentYear}-12-31`);
      const dateInput = document.getElementById('date');

      const minDate = today > allowedStart ? today : allowedStart;
      dateInput.setAttribute('min', minDate.toISOString().split('T')[0]);
      dateInput.setAttribute('max', allowedEnd.toISOString().split('T')[0]);

      const supabaseUrl = 'https://vaobmohukgcqfvnclqyh.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhb2Jtb2h1a2djcWZ2bmNscXloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ3NTcyNzksImV4cCI6MjA2MDMzMzI3OX0.6pl5QBTVUr8wu3bn4kXhI2kPE5qf97PrIbUw7-0382M';
      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

      // cache units + availability map for current date
      let unitsCache = [];
      const bookedMap = new Map(); // unitId -> true/false
      let isChecking = false;

      function clearSelectedUnitUI() {
        document.getElementById('unit').value = '';
        document.getElementById('unitDisplayText').textContent = 'None';
        document.querySelectorAll('.unit-card-btn').forEach(b => b.classList.remove('selected'));
      }

      function renderUnits() {
        const unitGrid = document.getElementById('unitGrid');
        const unitHidden = document.getElementById('unit');
        const unitDisplayText = document.getElementById('unitDisplayText');
        const hasDate = !!document.getElementById('date').value;

        unitGrid.innerHTML = '';

        unitsCache.forEach(unit => {
          const booked = hasDate ? !!bookedMap.get(unit.id) : false;

          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'unit-card-btn';
          btn.dataset.unitId = unit.id;
          btn.dataset.unitName = unit.name;

          const badgeText = !hasDate ? 'Pick a date' : (isChecking ? 'Checking...' : (booked ? 'Booked' : 'Available'));

          btn.innerHTML = `
            <div class="unit-badge">${badgeText}</div>
            <img src="${unit.thumbnail_url}" alt="${unit.name}" />
            <div class="unit-name">${unit.name}</div>
          `;

          if (hasDate && !isChecking && booked) {
            btn.classList.add('booked');
            btn.setAttribute('aria-disabled', 'true');
          }

          btn.addEventListener('click', () => {
            const chosenDate = document.getElementById('date').value;
            if (!chosenDate) {
              alert('Please select a date first so we can check availability.');
              return;
            }
            if (isChecking) {
              alert('Checking availability… please try again in a second.');
              return;
            }
            if (bookedMap.get(unit.id)) {
              alert('Sorry — this unit is already booked on this date. Please choose another unit or date.');
              return;
            }

            unitGrid.querySelectorAll('.unit-card-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            unitHidden.value = unit.name;
            unitDisplayText.textContent = unit.name;
          });

          unitGrid.appendChild(btn);
        });
      }

      async function loadUnits() {
        const { data, error } = await supabase.from('units').select('id, name, thumbnail_url');
        if (error) return;

        unitsCache = data || [];
        renderUnits();
      }

      // ✅ EXACT same check as checkout, just done for each unit when date is selected.
      async function checkAvailabilityLikeCheckout(dateStr) {
        if (!dateStr || unitsCache.length === 0) return;

        isChecking = true;

        // show "Checking..." badges immediately
        bookedMap.clear();
        renderUnits();

        // run the same query checkout uses: bookings where unit = unitId AND date = dateStr
        // (we do it for every unit)
        const checks = unitsCache.map(async (unit) => {
          const { data: existing, error } = await supabase
            .from('bookings')
            .select('id')
            .eq('unit', unit.id)
            .eq('date', dateStr)
            .limit(1);

          if (error) {
            // if query fails, treat as unknown -> not booked (so you don't block everyone)
            bookedMap.set(unit.id, false);
            return;
          }

          bookedMap.set(unit.id, (existing && existing.length > 0));
        });

        await Promise.allSettled(checks);

        isChecking = false;
        renderUnits();

        // if selected unit is now booked, clear it
        const selectedUnitName = document.getElementById('unit').value;
        if (selectedUnitName) {
          const selectedUnit = unitsCache.find(u => u.name === selectedUnitName);
          if (selectedUnit && bookedMap.get(selectedUnit.id)) {
            clearSelectedUnitUI();
          }
        }
      }

      // date validation + availability check
      dateInput.addEventListener('change', async () => {
        const selected = new Date(dateInput.value);
        if (selected.getFullYear() !== currentYear) {
          alert("You may only book dates within this year. Bookings for next year open January 1st.");
          dateInput.value = '';
          bookedMap.clear();
          isChecking = false;
          renderUnits();
          clearSelectedUnitUI();
          return;
        }

        await checkAvailabilityLikeCheckout(dateInput.value);
      });

      await loadUnits();

      const cart = [];
      document.getElementById('addToCartBtn').addEventListener('click', async () => {
        const unitName = document.getElementById('unit').value;
        const date = document.getElementById('date').value;

        if (!unitName || !date) {
          alert('Please select a unit and a date before adding to cart.');
          return;
        }

        const isDuplicate = cart.some(item => item.unitName === unitName && item.date === date);
        if (isDuplicate) {
          alert('This unit and date combination is already in your cart.');
          return;
        }

        // keep UI + cart consistent with checkout source
        await checkAvailabilityLikeCheckout(date);
        const unitRow = unitsCache.find(u => u.name === unitName);
        if (unitRow && bookedMap.get(unitRow.id)) {
          alert('That unit is already booked on this date.');
          clearSelectedUnitUI();
          return;
        }

        cart.push({ unitName, date });

        const cartSection = document.getElementById('cartSection');
        const cartList = document.getElementById('cartList');
        cartSection.style.display = 'block';

        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `${unitName} — ${date} <button class="btn btn-sm btn-danger">&times;</button>`;
        li.querySelector('button').addEventListener('click', () => {
          const index = cart.findIndex(item => item.unitName === unitName && item.date === date);
          if (index !== -1) cart.splice(index, 1);
          li.remove();
          if (cart.length === 0) cartSection.style.display = 'none';
        });
        cartList.appendChild(li);
      });

      document.getElementById('bookingForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const name = document.getElementById('name').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const email = document.getElementById('email').value.trim();
        const address = document.getElementById('address').value.trim();
        const city = document.getElementById('city').value.trim();

        if (cart.length === 0) {
          alert('Your cart is empty. Please add at least one booking.');
          return;
        }

        let allSuccessful = true;

        for (const item of cart) {
          const { unitName, date } = item;

          const { data: unitData, error: unitError } = await supabase
            .from('units')
            .select('id')
            .eq('name', unitName)
            .single();

          if (unitError || !unitData) {
            allSuccessful = false;
            continue;
          }

          const unitId = unitData.id;

          const { data: existing } = await supabase
            .from('bookings')
            .select('*')
            .eq('unit', unitId)
            .eq('date', date);

          if (existing && existing.length > 0) {
            allSuccessful = false;
            continue;
          }

          const { error: insertError } = await supabase.from('bookings').insert([
            { name, phone, email, address, city, unit: unitId, date }
          ]);

          if (insertError) {
            allSuccessful = false;
          } else {
            const params = { name, phone, email, address, city, unit: unitName, date };
            emailjs.send("service_1zxrd0j", "template_nqep0gt", params);
            emailjs.send("service_1zxrd0j", "template_6z2dcsj", params);
          }
        }

        if (allSuccessful) {
          document.getElementById('successMessage').style.display = 'block';
          document.getElementById('errorMessage').style.display = 'none';
          document.getElementById('bookingForm').reset();

          clearSelectedUnitUI();
          cart.length = 0;
          document.getElementById('cartList').innerHTML = '';
          document.getElementById('cartSection').style.display = 'none';

          bookedMap.clear();
          isChecking = false;
          renderUnits();
        } else {
          document.getElementById('successMessage').style.display = 'none';
          document.getElementById('errorMessage').style.display = 'block';

          const d = document.getElementById('date').value;
          if (d) await checkAvailabilityLikeCheckout(d);
        }
      });
    });
  </script>
</body>
</html>
