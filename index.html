<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Slide Guys Booking</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.5/dist/umd/supabase.min.js"></script>
  <script type="text/javascript" src="https://cdn.emailjs.com/dist/email.min.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
      padding: 2rem;
    }
    .logo {
      max-width: 250px;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="text-center">
      <img src="https://i.ibb.co/zrmz7tk/Untitled-design-3.png" alt="Logo" class="logo"/>
      <h2 class="mb-4">Book Your Slide</h2>
    </div>

    <form id="bookingForm">
      <div class="form-group">
        <label for="name">Name</label>
        <input class="form-control" type="text" id="name" required>
      </div>
      <div class="form-group">
        <label for="phone">Phone</label>
        <input class="form-control" type="tel" id="phone" required>
      </div>
      <div class="form-group">
        <label for="email">Email</label>
        <input class="form-control" type="email" id="email" required>
      </div>
      <div class="form-group">
        <label for="address">Address</label>
        <input class="form-control" type="text" id="address" required>
      </div>
      <div class="form-group">
        <label>Choose a Unit</label>
        <div class="dropdown">
          <button class="btn btn-outline-primary dropdown-toggle w-100" type="button" id="unitDisplay" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Select a unit
          </button>
          <div class="dropdown-menu w-100" id="unitDropdown"></div>
        </div>
        <input type="hidden" id="unit" required>
      </div>
      <div class="form-group">
        <label for="date">Choose a Date</label>
        <input class="form-control" type="date" id="date" required>
      </div>

      <button type="button" id="addToCart" class="btn btn-secondary w-100 mb-3">Add to Cart</button>
    </form>

    <div id="cartContainer" class="text-start mt-4">
      <h5>Booking Cart</h5>
      <ul id="cartList" class="list-group mb-3"></ul>
      <button id="submitCart" class="btn btn-primary w-100" style="display:none;">Confirm Reservation</button>
    </div>
  </div>

  <script>
    const supabase = supabase.createClient(
      'https://vaobmohukgcqfvnclqyh.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhb2Jtb2h1a2djcWZ2bmNscXloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ3NTcyNzksImV4cCI6MjA2MDMzMzI3OX0.6pl5QBTVUr8wu3bn4kXhI2kPE5qf97PrIbUw7-0382M
'
    );

    emailjs.init("PXm_wNk9aIao8Hlpp");

    document.addEventListener('DOMContentLoaded', async () => {
      const { data: units } = await supabase.from('units').select('*');
      const unitDropdown = document.getElementById('unitDropdown');

      units.forEach(unit => {
        const btn = document.createElement('button');
        btn.className = 'dropdown-item';
        btn.type = 'button';
        btn.textContent = unit.name;
        btn.onclick = () => {
          document.getElementById('unitDisplay').textContent = unit.name;
          document.getElementById('unit').value = unit.name;
        };
        unitDropdown.appendChild(btn);
      });

      const cart = [];
      const cartList = document.getElementById('cartList');
      const submitCartBtn = document.getElementById('submitCart');

      document.getElementById('addToCart').addEventListener('click', async () => {
        const unitName = document.getElementById('unit').value;
        const date = document.getElementById('date').value;
        if (!unitName || !date) return alert('Please select both a unit and a date.');

        if (cart.some(item => item.unit === unitName && item.date === date)) {
          alert('This unit and date are already in your cart.');
          return;
        }

        cart.push({ unit: unitName, date });

        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.textContent = `${unitName} on ${date}`;
        const removeBtn = document.createElement('button');
        removeBtn.className = 'btn btn-sm btn-danger';
        removeBtn.textContent = 'Remove';
        removeBtn.onclick = () => {
          cart.splice(cart.indexOf(cart.find(i => i.unit === unitName && i.date === date)), 1);
          cartList.removeChild(li);
          if (cart.length === 0) submitCartBtn.style.display = 'none';
        };
        li.appendChild(removeBtn);
        cartList.appendChild(li);
        submitCartBtn.style.display = 'block';

        document.getElementById('unitDisplay').textContent = 'Select a unit';
        document.getElementById('unit').value = '';
        document.getElementById('date').value = '';
      });

      submitCartBtn.addEventListener('click', async () => {
        const name = document.getElementById('name').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const email = document.getElementById('email').value.trim();
        const address = document.getElementById('address').value.trim();

        if (!name || !phone || !email || !address) {
          alert('Please fill out your contact info before submitting.');
          return;
        }

        for (const item of cart) {
          const { data: unitData } = await supabase
            .from('units')
            .select('id')
            .eq('name', item.unit)
            .single();

          if (!unitData) {
            alert(`Unit not found: ${item.unit}`);
            continue;
          }

          const unitId = unitData.id;
          const { data: existing } = await supabase
            .from('bookings')
            .select('*')
            .eq('unit', unitId)
            .eq('date', item.date);

          if (existing && existing.length > 0) {
            alert(`Sorry, ${item.unit} is already booked on ${item.date}. Skipping.`);
            continue;
          }

          await supabase.from('bookings').insert([
            { name, phone, email, address, unit: unitId, date: item.date }
          ]);

          const params = { name, phone, email, address, unit: item.unit, date: item.date };
          emailjs.send("service_1zxrd0j", "template_nqep0gt", params);
          emailjs.send("service_1zxrd0j", "template_6z2dcsj", params);
        }

        alert('All available bookings submitted!');
        cart.length = 0;
        cartList.innerHTML = '';
        submitCartBtn.style.display = 'none';
        document.getElementById('bookingForm').reset();
      });
    });
  </script>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
